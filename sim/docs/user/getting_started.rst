Getting started
===============

Last updated: 07/13/2018, Daniel Johansson

Download
--------

Download the ACN simulator from Github either by cloning the repository or downloading the source code directly.

Importing libraries
-------------------

Open the terminal window and change directory to the ``ACN-portal/sim`` folder. To use the simulator, create a new script
in this directory and import the necessary libraries and classes by including the following code section at the top of
the script:

.. code-block:: python

    from datetime import datetime
    import TestCase
    from BaseAlgorithm import *
    from GraphDrawer import GraphDrawer
    from ACNsim import ACNsim

:TestCase:
    A TestCase defines which data the simulation will operate on. It also holds the current status of the
    simulation and saves the data of the simulation.

:BaseAlgorithm:
    All scheduling algorithms must extend the ``BaseAlgotithm`` class in order to be used in the simulation.
    The ``BaseAlgorithm`` class also includes resources usefull for the scheduling algorithms, e.g. the API used to
    extract the relevant data to make an efficient algorithm.

:GraphDrawer:
    The ``GraphDrawer`` is a library for extracting and visualizing the status and result of a simulation.

:ACNsim:
    The ``ACNsim`` is the main class for the simulation. It handles all the interconnections of the other classes and
    runs the simulation.

Creating a Test Case
--------------------

A Test Case can be generated on either real data from Caltech's ACN network, or from syntetic data from a statistical
model based on the data generated from the same network.

**From real data:**

When the ``TestCase`` module is imported the test case is generated by running the following piece of code:

.. code-block:: python

    test_case = TestCase.generate_test_case_local('sessions_data.pkl',
                                                  datetime.strptime("18/04/18", "%d/%m/%y"),
                                                  datetime.strptime("25/04/18", "%d/%m/%y"))

The charging session data used for this test case is taken from the file ``session_data.pkl``. The argument entered into
the function ``generate_test_case_local`` is the name of the pickle_ file which is a serialized pyhton object.
The data in the file is stored as a two dimensional array where every row holds information about an EV charging sesssion.
Every row has four elements with index 0 to 3.

===== ========= ======================
Index Data type Description
===== ========= ======================
0     Timestamp Arrival time
----- --------- ----------------------
1     Timestamp Departure time
----- --------- ----------------------
2     float64   Energy demand [kWh]
----- --------- ----------------------
3     str       Charging station index
===== ========= ======================

The second and third element are the starting and ending times from where the data should be extracted from. If the ``session_data.pkl``
file has data for the whole year the, only one week in April will be extracted in the example in the code block above.

.. _pickle: https://docs.python.org/3/library/pickle.html

Additional arguments can be passed to the ``generate_test_case_local`` to change some simulation settings.

:voltage: Specifies the Grid voltage level. Standard value: 220 [V]

:max_rate: Specifies the maximum charging rate for one EV. Standard value: 32 [A]

:period: Specifies the length of one iteration of the simulation. Standard value: 1 [minute]

**From statistical model:**

##### NOT YET IMPLEMENTED #####

Define scheduling algorithm
---------------------------

The ``BaseAlgorithm`` module has already som predefined charging algorithms that can be used if no other algorithm has yet been
defined. The section :ref:`writing-a-scheduling-algorithm` covers how to implement a custom scheduling algorithm which can be used in the same way as the ones
covered in this section.

The predefined scheduling algorithms are:

:EarliestDeadlineFirst:
    An algorithm that prioritize the EV that has to depart first. All other EVs are charged with minimum rate.

:LeastLaxityFirst:
    An algorithm that prioritize the EV with least laxity first. All other EVs are charged with minimum rate.

:MLLF:
    Multi Least Laxity First. An algorithm that ranks the EVs according to their laxity and then prioritizes the EVs with
    least laxities. As the laxity ranking changes as the EVs charge there is an option to allow preemption of the sessions, i.e.
    an EV can interrupt another EV that is charging at full rate when it get a smaller laxity value.

To define which algorithm to use, simply create an object of the corresponding scheduling class to be used:

.. code-block:: python

    scheduler = EarliestDeadlineFirst()

Some scheduling algorithms can also take arguments:

.. code-block:: python

    scheduler = MLLF(preemtion=True, queue_length=2)


Run simulation
--------------

When both the test case and the scheduler has been defined it is possible to run the simulation. To do this, simply define
the simulator and then pass the test case and the scheduler objects to its simulation function:

.. code-block:: python

    acnsim = ACNsim()
    acnsim.simulate(test_case, scheduler)

This will run the full simulation and the data will be stored in the TestCase object.

Analyze simulation result
-------------------------

When the simulation has finished the simulation data are stored in the TestCase object.

To see the result from the simulation it is possible to pass this object to the ``GraphDrawer`` library. There are several
functions that can be used to view different aspects of the simulation. The available functions are described here.

An code example is presented below which will plot the charging activity for each station during 3 days along the algorithm performance.
The corresponding output graphs are also included.

.. code-block:: python

    gd = GraphDrawer()
    gd.plot_station_activity(test_case)
    gd.plot_EV_behavioral_stats(test_case)


Sample code
-----------

Below follows a script with all the commands used above which can be used as a reference for using the simulator.

.. code-block:: python

    from datetime import datetime
    import TestCase
    from BaseAlgorithm import *
    from GraphDrawer import GraphDrawer
    from ACNsim import ACNsim

    test_case = TestCase.generate_test_case_local('sessions_data.pkl',
                                                  datetime.strptime("18/04/18", "%d/%m/%y"),
                                                  datetime.strptime("25/04/18", "%d/%m/%y"))
    scheduler = MLLF(preemtion=True, queue_length=2)

    acnsim = ACNsim()
    acnsim.simulate(test_case, scheduler)

    gd = GraphDrawer()
    gd.plot_station_activity(test_case)
    gd.plot_EV_behavioral_stats(test_case)
